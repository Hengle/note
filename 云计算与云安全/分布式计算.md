<!-- TOC -->

- [1. 基本概念](#1-基本概念)
- [2. 分布式计算的优点](#2-分布式计算的优点)
- [3. 步骤](#3-步骤)
- [4. 理论基础](#4-理论基础)
    - [4.1. 一致性](#41-一致性)
    - [4.2. ACID原则](#42-acid原则)
    - [4.3. CAP理论](#43-cap理论)
    - [4.4. BASE理论](#44-base理论)
    - [4.5. 一致性散列](#45-一致性散列)
- [5. 分布式系统](#5-分布式系统)
    - [5.1. 特性](#51-特性)
    - [5.2. Hadoop](#52-hadoop)
        - [5.2.1. 模块组成](#521-模块组成)
        - [5.2.2. Hadoop分布式文件系统](#522-hadoop分布式文件系统)
        - [5.2.3. 特性](#523-特性)
        - [5.2.4. 缺陷](#524-缺陷)
    - [5.3. 分布式存储系统](#53-分布式存储系统)
        - [5.3.1. 子方向](#531-子方向)
    - [5.4. 分布式计算系统](#54-分布式计算系统)
        - [5.4.1. 类别](#541-类别)
    - [5.5. 分布式资源管理系统](#55-分布式资源管理系统)
        - [5.5.1. 特性](#551-特性)
        - [5.5.2. 实际](#552-实际)
    - [5.6. 典型的分布式系统](#56-典型的分布式系统)
- [6. 云计算架构](#6-云计算架构)
    - [6.1. 云数据中心](#61-云数据中心)
    - [6.2. 云栈和云体](#62-云栈和云体)
    - [6.3. 软件定义](#63-软件定义)
- [7. OpenStack](#7-openstack)
    - [7.1. 功能](#71-功能)
    - [7.2. 组件](#72-组件)

<!-- /TOC -->
# 1. 基本概念
分布式计算的概念是相比较于集中式计算概念来说的。分布式计算就是在两个或多个软件互相共享信息，这些软件既可以在同一台计算机上运行，也可以在通过网络（用于通信和协调）连接起来的多台计算机上运行。
# 2. 分布式计算的优点
* 资源共享
* 负载均衡
# 3. 步骤
* 确定组件的运行方式
* 确定组件、节点的管理办法
* 确定任务分配算法：如何分配任务以及回收任务结果，最好每个节点的计算互不相干，这样可以减少节点之前的等待时间
* 确定节点之间的通信方式
    * 消息队列
    * 分布式存储系统（文件、数据库、内存共享）
# 4. 理论基础
## 4.1. 一致性
一致性要求是大多数互联网应用的主要要求，有以下几种情况（强一致性和最终一致性比较常见）：
* 强一致性：对于关系型数据库，要求更新过的数据能被后续的访问都能看到
* 弱一致性：能容忍后续的部分或者全部访问不到
* 最终一致性：经过一段时间后要求能访问到更新后的数据
* 因果一致性
* 读写一致性
* 会话一致性
* 读一致性
* 写一致性
## 4.2. ACID原则
数据库事务正常执行的四个原则原子性、一致性（这里的一致性指的是强一致性）、独立性和持久性解决了数据的一致性、系统的可靠性等关键问题，但是这四个原则在分布式计算的环境下很难实现。
## 4.3. CAP理论
在一个分布式系统中，一致性（这里的一致性指的是强一致性）、可用性和分区容错性这三个要素最多只能同时实现两点，不可能三者兼顾。至于要舍弃哪一个，需要根据实际场景来选择最合适的。
## 4.4. BASE理论
BASE是指基本可用、软状态和最终一致性，BASE主要用于大型分布式系统，通过牺牲强一致性来获取高可用性。在分布式系统的设计场景中，系统组件对于一致性的要求是不同的，所以BASE理论可能会和ACID原则结合使用。
* 基本可用：指分布式系统在出现故障的时候，允许损失部分可用性（例如响应时间延长、功能降级）
* 软状态：软状态是指允许系统存在中间状态，而该中间状态不会影响系统整体可用性。分布式存储中一般一份数据会有多个副本，允许不同副本同步的延时就是软状态的体现。mysql replication的异步复制也是一种体现。
* 最终一致性：指系统中的所有数据副本经过一定时间后，最终能够达到一致的状态。
## 4.5. 一致性散列
一致性散列指的是将散列空间画成圆形，节点位于圆上，数据则在确定落点后进行顺时针旋转，最后存储到碰到的第一个节点上。一致性散列有三个特点：
* 容错性：高容错率
* 拓展性：拓展节点方便
* 虚拟节点：可以将一个节点拆分为多个虚拟节点，增加转换步骤，可以减少数据倾斜导致负载不均衡的问题
# 5. 分布式系统
## 5.1. 特性
* 容错性
* 高可拓展性
* 开放性
* 并发处理能力
* 透明性（对于外界是一个整体）
## 5.2. Hadoop
### 5.2.1. 模块组成
* Hadoop分布式文件系统（基于谷歌GFS）
* MapReduce分布式计算系统
### 5.2.2. Hadoop分布式文件系统
* NameNode：NameNode是整个集群的管理者。它并不存储数据本身而负责存储文件系统的元数据。它负责管理文件系统名称空间并控制外部客户端对文件系统的访问。NameNode决定如何将文件内容映射到DataNode的数据块上。此外实际数据传输并不会经过NameNode而会让对应的DataNode接收实际数据并处理分布式存储系统的负载均衡问题。整个文件系统只有一个NameNode因此很明显集群可能会出现单点故障这点需要利用SecondaryNameNode来解决问题。
* SecondaryNameNode：NameNode的备份节点。HDFS会将NameNode的数据实时备份到SecondaryNameNode上当NameNode宕机需要重启时则可以利用SecondaryNameNode中的数据加快NameNode的重启恢复速度。
* DataNode：实际的数据存储节点负责相应NameNode创建、删除和复制块的命令。NameNode会读取来自DataNode的心跳信息以此判断DataNode是否存活。同一份数据会以多份副本存储在不同的DataNode上一旦某一个DataNode宕机NameNode会立即采取手段来处理问题。
* MapReduce模型：Hadoop中的模块也是一个计算模型。用户需要自己将算法划分成Map和Reduce两个阶段。首先将数据划分为小块的数据将数据分配到不同计算节点的Map任务中计算然后将计算结果汇总到Reduce节点中进行合并得出最终结果。MapReduce系统也是主从式的计算系统。在使用YARN后每个集群有一个Resource-Manager用于管理整个集群。集群中每个计算节点都有一个NodeManager负责管理某个节点的容器并监视其资源使用。每个应用程序由一个MRAppMaster进行管理。
### 5.2.3. 特性
* 高可靠性：ApacheHadoop可以可靠地将数据存储到节点上。
* 高可扩展性：ApacheHadoop的存储和计算节点可以快速扩展并自动进行负载均衡。
* 高效性：一方面ApacheHadoop会自动在各个节点之间动态调动数据保证每个节点存储均衡另一方面读取数据时我们可以从不同节点并行读取提高数据读取的速度。
* 高容错性：ApacheHadoop会将数据冗余存储在不同节点上保证数据容错性计算任务失败时也会自动重新分配任务。
* 低成本：ApacheHadoop是开源软件可以节省商业软件的购买成本。同时ApacheHadoop可以用廉价节点组成的集群取代昂贵的超级计算机从而可以节省硬件成本。
### 5.2.4. 缺陷
ApacheHadoop虽然是异常可靠的分布式计算框架但其计算存储模型也导致它的严重缺陷——实时性较差。MapReduce计算模型本身是一种批处理的计算模型也就是积累一批数据启动MapReduce任务处理完这一批数据等到下次积累到一定程度再定时或手动启动一轮新任务而不是随着数据到来即时处理。此外HDFS不是一个高实时性的分布式文件系统。为了提高其实时性我们还需要自己加上很多缓存优化。而致命问题在于MapReduce各个任务之间的通信完全使用HDFS完成这也就从根本上导致MapReduce不可能具有极高的实时性。这也为后来Spark计算框架的普及提供了空间。
## 5.3. 分布式存储系统
### 5.3.1. 子方向
* 结构化存储：如MySQL，拓展性差
* 非结构化存储：如GFS，实时性差
* 半结构化存储：如NoSQL
* In-Memory存储：如Redis，使用内存
* NewSQL：如F1，系统复杂
## 5.4. 分布式计算系统
### 5.4.1. 类别
* 传统基于消息的系统：MPI
* MapReduce：Spark
* 基于状态的系统：Dato
* 图计算系统：DistBelief
* 实时流处理系统：Storm
## 5.5. 分布式资源管理系统
在不同的场景下，使用的分布式系统不同，但是资源是可以共用的，所以可以将多个分布式系统部署到一个公共集群中，由集群管理资源。
### 5.5.1. 特性
* 支持多种计算框架：资源统一管理和调度平台应该提供一个全局的资源管理器。所有接入的框架要先向该全局资源管理器申请资源，申请成功之后，再由框架自身的调度器决定资源交由哪个任务使用，也就是说，整个系统是个双层调度器，第一层是统一管理和调度平台提供的，另外一层是框架自身的调度器。资源统一管理和调度平台应该提供资源隔离。不同的框架中的不同任务往往需要的资源（内存、CPU、网络I/O等）不同，它们运行在同一个集群中，会相互干扰，为此，应该提供一种资源隔离机制避免任务之间由资源争用导致效率下降。
* 扩展性：现有的分布式计算框架都会将系统扩展性作为一个非常重要的设计目标（例如Hadoop），好的扩展性意味着系统能够随着业务的扩展线性扩展。资源统一管理和调度平台融入多种计算框架后，不应该破坏这种特性，也就是说，统一管理和调度平台不应该成为制约框架进行水平扩展。
* 容错性：同扩展性类似，容错性也是当前分布式计算框架的一个重要设计目标，统一管理和调度平台在保持原有框架的容错特性基础上，自己本身也应具有良好的容错性。
* 高资源利用率：如果采用静态资源分配，也就是每个计算框架分配一个集群，往往由于作业自身的特点或者作业提交频率等原因，集群利用率很低。当各种框架部署到同一个大的集群中，进行统一管理和调度后，各种作业交错且作业提交频率大幅度升高，为资源利用率的提升增加了机会，如图2.14所示。
* 细粒度的资源分配：细粒度的资源分配是指直接按照任务实际需求分配资源，而不是像MapReduce那样将槽位作为资源分配单位。这种分配机制可大大提高资源利用率，如图2.15所示。
### 5.5.2. 实际
当前比较有名的开源资源统一管理和调度平台有两个，Mesos和YARN。Mesos诞生于加州大学伯克利分校的一个研究项目，现已成为ApacheIncubator中的项目，当前有一些公司使用Mesos管理集群资源，例如Twitter。
而YARN是下一代MapReduce，是在第一代MapReduce基础上演变而来的，主要是为了解决原始Hadoop扩展性较差，不支持多计算框架而提出的。它完全不同于HadoopMapReduce，所有代码全部重写。整个平台由ResourceManager和NodeManager组成。与HadoopMapReduce相比，其最大特点是将JobTracker拆分成ResourceManager和ApplicationMaster，其中ResourceManager是全局的资源管理器，仅负责资源分配，而ApplicationMaster对应一个具体的应用（如Hadoopjob、Sparkjob等），主要负责应用的资源申请，启动各个任务和运行状态监控（没有调度功能）。
随着容器技术的流行，面向容器的资源管理与调度系统也成为人们关注的焦点，除了上面提到的ApacheMesos之外，Docker的Swarm和Google的Kubernetes也成为这方面的明星。特别是Kubernetes，大有统一容器界的资源管理的趋势。Kubernetes是Google在2014年提出的开源项目，其开发设计思想深受Google的Borg系统影响。
Google很早就认识到了Docker镜像的潜力，并设法在GoogleCloudPlatform上实现「容器编排」即服务。Google虽然在容器方面有着深厚的经验，但它现有的内部容器和Borg等分布式计算工具是和基础设施紧密耦合的。因此，Google没有使用任何现有系统的代码，而是重新设计了Kubernetes对Docker容器进行编排。Kubernetes的目标和构想如下：
为广大应用开发者提供一个强大的工具来管理Docker容器的编排，而不再需要和底层基础架构进行交互；
提供标准的部署接口和元语，以获得一致的应用部署的体验和跨云的API；
建立一个模块化的API核心，允许厂商以Kubernetes技术为核心进行系统集成。
2016年3月，Google向CNCF捐赠了Kubernetes，至今仍然保持着在这个项目的贡献者中首位的位置。发展至今，Kubernetes已经从一个单体的庞大代码库向一个生态型多个代码库演进；除了主体代码库之外，还有约40个其他的插件代码库和超过20个的孵化项目。
## 5.6. 典型的分布式系统
* 网格系统
* P2P
* 透明计算
* 区块链
# 6. 云计算架构
核心理念：将所有的IT资产作为服务。架构已经不局限于C/S和B/S架构，而是面向服务的架构。
## 6.1. 云数据中心
* 数据中心模式
* 集装箱模式
## 6.2. 云栈和云体
* 云栈：支持云计算的平台，从业务过程、应用软件、中间件、操作系统到虚拟硬件、物理硬件
* 云体：云计算资源，包括CPU、内存、存储等
## 6.3. 软件定义
软件定义资源、计算、存储和网络
# 7. OpenStack
## 7.1. 功能
* 充分利用物理服务器、虚拟服务器、网络和存储系统资源
* 通过租户、配额和用户角色高效管理云资源
* 提供一个对底层透明的通用的资源控制接口
## 7.2. 组件
|项目|代码名称|描述|
|:-:|:-:|:-:|
|计算（Compute）|Nova|管理虚拟机资源，包括CPU、内存、磁盘和网络接口|
|网络（Networking）|Neutron|提供虚拟机网络接口资源，包括IP寻址、路由和软件定义网络（SDN）|
|对象存储（Object Storage）|Swift|提供可通过Restful API访问的对象存储|
|块存储（Block Storage）|Cinder|为虚拟机提供块（传统磁盘）存储|
|身份认证服务（Identity）|Keystone|为OpenStack组件提供基于角色的访问控制（RBAC）和授权服务|
|镜像服务（Image Service）|Glance|管理虚拟机磁盘镜像，为虚拟机和快照（备份）服务提供镜像|
|仪表盘（Dashboard）|Horizon|为OpenStack提供基于Web的图形界面|
|计量服务（Telemetry）|Ceilometer|集中为OpenStack各个组件收集计量和监控数据|
|编排服务（Orchestration）|Heat|为OpenStack环境提供基于模板的云应用编排服务|